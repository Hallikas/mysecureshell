#!/bin/sh

## Installation Script v0.8 - Made by Pierre
## MySecureShell Team <teka2nerdman@users.sourceforge.net>

## Language local initialising

BINDIR=@BINDIR@
ETCDIR=@ETCDIR@
MSS_CONF=@MSS_CONF@
MSS_LOG=@MSS_LOG@
LANG=

## Functions Looking for available languages

MyGetLocale()
{
	if [ "$LANG" == "" ] ; then
		echo $1
	else
		tmp=`grep -F "$1=" locales_$LANG | cut -d= -f2-`
		if [ "$tmp" == "" ] ; then
			echo $1
		else
			echo $tmp
		fi
	fi
}

MyListLocale()
{
	echo "The available languages are:"
	grep -F 'DESCRIPTION=' locales_* | cut -d= -f2-
	echo ""
	echo "Usage:"
	echo "./install.sh xx(language) | or yesall for yes to all questions"
}

if [ "$1" = "yesall" ] ; then
	fyesall="1"
	break
else
	if [ "$1" == "" ] ; then
		MyListLocale
		exit 1
	else
		if [ -f "locales_$1" ] ; then
			LANG=$1
			fyesall="0"
		fi
	fi
fi

## Root detection

if [ `whoami` == "root" ] ; then
	echo ""
else
	echo -e "\n###################################################################"
	tmp=`MyGetLocale 'sorry'`
	echo -e "\t\t\t"$tmp `whoami`
	MyGetLocale 'Warning root ask'
	echo -e "###################################################################\n"
	exit 1
fi

## Functions
detecfiles() {
	fileufund=`MyGetLocale 'Existing file'`" $filedetec\t\t\t`MyGetLocale 'failed'`
	echo -e "$fileufund"
	instend=`MyGetLocale 'installation'`"\t\t\t\t"`MyGetLocale 'failed'`"
	echo -e "$instend"
        exit 1
}

filefound() {
	filefund=`MyGetLocale 'Existing file'`" $filedetec\t\t\t`MyGetLocale 'ok'`"
	echo -e "$filefund"
}

shellfunc() {
grepshell=`grep /bin/MySecureShell /etc/shells`
if [ $? == 0 ] ; then
	sftpinst=$sftpinst`MyGetLocale 'shellalreadyvd'`"\t\t"`MyGetLocale 'ok'`"\n"
else
	MyGetLocale 'validshellask'
	if [ "$fyesall" = "1" ] ; then
		rep3="y"
	else
		read rep3
	fi
	if [ $rep3 = "y" ] ; then
		echo "/bin/MySecureShell" >> /etc/shells
		sftpinst=$sftpinst`MyGetLocale 'shellvalid'`"\t\t"`MyGetLocale 'ok'`"\n"
	else
		if [ $rep3 = "n" ] ; then
			sftpinst=$sftpinst`MyGetLocale 'novalidshell'`"\t"`MyGetLocale 'ok'`"\n"
		else
			clear  	    
			instend=`MyGetLocale 'installation'`"\t\t\t"`MyGetLocale 'failed'`"\t\n"
			echo -e "$instend"
			MyGetLocale 'answers'
			exit 1
		fi
	fi
fi
}

## Starting script
## Welcome and files detection

clear
echo "#########################################"
echo -e "#\t\tMySecureShell\t\t#"
echo -e "#########################################\n"
tmp=`MyGetLocale 'Welcome'`
echo -e $tmp "\n"

MyGetLocale 'Needed installation files'
filedetec="MySecureShell"
if [ -f ./$filedetec ] ; then
	filefound
	filedetec="sftp_config"
	if [ -f ./$filedetec ] ; then
		filefound
     	else
		detecfiles
   	fi
else
 	detecfiles
fi

## Test system

echo -e "\n"
tmp=`MyGetLocale 'TestSystem?'`
echo -n $tmp
if [ $fyesall = "1" ] ; then
	rep7="y"
else
	read rep7
fi

if [ $rep7 = "y" ] ; then
    MyGetLocale 'LaunchMSS'
    ./MySecureShell --configtest > /dev/null
    MyGetLocale 'LaunchSftpMSS'
    ./MySecureShell -c /usr/lib/sftp-server < /dev/null
    MyGetLocale 'Testsuccess'
fi

## Introduction text

echo -e "\n"
MyGetLocale 'text1'
MyGetLocale 'text2'
MyGetLocale 'text3'
MyGetLocale 'text4'
MyGetLocale 'text5'
echo ""
MyGetLocale 'statestopquest'
MyGetLocale 'text6'

## Starting or ending installation

if [ $fyesall = "1" ] ; then
	rep1="y"
else
	read rep1
fi


if [ $rep1 = "y" ] ; then
	tmp=`MyGetLocale 'installation'`
	echo -e "$tmp\n"
else
	clear
	tmp2=`MyGetLocale 'installation'`"\t\t\t\t"`MyGetLocale 'failed'`"\n"
	if [ $rep1 = "n" ] ; then
		break
	else
		MyGetLocale 'answers'
	fi
	echo -e "$tmp2"
exit 1
fi

## If MSS is present, stop server

if [ -f $BINDIR/sftp-state ] ; then
	if [ $fyesall = "1" ] ; then
		$BINDIR/sftp-state -yes stop > /dev/null
	else
		$BINDIR/sftp-state stop
	fi
fi

## Existing ssh or sshd folder

if [ -d $ETCDIR/sshd ] ; then
	sshfolder=$ETCDIR/sshd
else
	if [ -d $ETCDIR/ssh ] ; then
		sshfolder=$ETCDIR/ssh
	else
		MyGetLocale 'mksshfolder'
		if [ $fyesall = "1" ] ; then
			repssh="y"
		else
			read repssh
		fi
		if [ $repssh = 'y' ] ; then
			sshfolder=$ETCDIR/ssh
			mkdir $sshfolder
			sftpinst=`MyGetLocale 'lgsshfolder'`"\t\t\t\t"`MyGetLocale 'ok'`"\t\n"
		else
			clear
			MyGetLocale 'stopinstssh'
			echo -e "$tmp2"
			exit 1
		fi
	fi
fi

## Config file

if [ -f $MSS_CONF ] ; then
	echo -e "\n"
	MyGetLocale 'warnconf'
	MyGetLocale 'warnerase'
	if [ $fyesall = "1" ] ; then
		rep2="n"
	else
		read rep2
	fi
	if [ $rep2 = "y" ] ; then
		cp -f ./sftp_config $MSS_CONF
		chmod 644 $MSS_CONF
		sftpinst=`MyGetLocale 'conffilerep1'`"\t\t"`MyGetLocale 'ok'`"\t\n"
	else
		if [ $rep2 = "n" ] ; then
			sftpinst=$sftpinst`MyGetLocale 'conffilerep2'`"\t"`MyGetLocale 'ok'`"\t\n"
		else
			clear  	    
			instend=`MyGetLocale 'installation'`"\t\t\t\t"`MyGetLocale 'failed'`"\t\n"
			echo -e "$instend"
			MyGetLocale 'answers'
			exit 1
		fi
	fi
else
	cp -f ./sftp_config $MSS_CONF
	chmod 644 $MSS_CONF
	sftpinst=$sftpinst`MyGetLocale 'mkconffile'`"\t\t\t\t"`MyGetLocale 'ok'`"\t\n"
fi

## Updating Detection

if [ -f /bin/MySecureShell ] ; then
	sftpinst=$sftpinst`MyGetLocale 'upconffile'`"\t\t\t"`MyGetLocale 'ok'`"\t\n"
else
	sftpinst=$sftpinst`MyGetLocale 'mkconffile'`"\t\t\t\t"`MyGetLocale 'ok'`"\t\n"
fi
cp -f ./MySecureShell /bin
chmod 4755 /bin/MySecureShell

## /shells detection

if [ -f /etc/shells ] ; then
	shellfunc
else
	MyGetLocale 'mkshells'
	if [ $fyesall = "1" ] ; then
		repshells="y"
	else
		read repshells
	fi
	if [ $repshells = 'y' ] ; then
		touch /etc/shells
		chmod 644 /etc/shells
		shellfunc
	else
		clear  	    
		instend=`MyGetLocale 'installation'`"\t\t\t"`MyGetLocale 'failed'`"\t\n"
		echo -e "$instend"
		MyGetLocale 'answers'
	fi
fi

## Utilities installation

if [ -d ./utils ] ; then
	for tool in "sftp-who" "sftp-kill" "sftp-state" "sftp-admin" "sftp-verif" ; do	
		cp -f ./utils/$tool $BINDIR
		sftpinst=$sftpinst`MyGetLocale 'tool'`" $tool\t\t\t"`MyGetLocale 'ok'`"\n"
	done
	chmod 755 $BINDIR/sftp-who
	chmod 755 $BINDIR/sftp-kill
	chmod 700 $BINDIR/sftp-state
	chmod 700 $BINDIR/sftp-admin
	chmod 755 $BINDIR/sftp-verif
else
	sftpinst=$sftpinst`MyGetLocale 'noutilities'`"\t"`MyGetLocale 'ok'`"\n"
fi

## Logrotate

MyGetLocale 'logrot?'
if [ $fyesall = "1" ] ; then
	rep8="y"
else
	read rep8
fi
if [ $rep8 = 'y' ] ; then
	# Using for Debian like systems
	if [ -d /etc/logrotate.d ] ; then
		echo -e "$MSS_LOG {\n\tweekly\n\tsize=500k\n\trotate 10\n\tcompress\n\tdelaycompress\n\tmissingok\n\tnotifempty\n}" > /etc/logrotate.d/mysecureshell
		chmod 644 /etc/logrotate.d/mysecureshell
		sftpinst=$sftpinst`MyGetLocale 'logrot'`"\t"`MyGetLocale 'ok'`"\n"
	else
		# Others BSD systems
		if [ -f /etc/weekly ] ; then
		        logstat=1
			grep -e '^for' < /etc/weekly | grep -ve sftp-server.log > /dev/null
		        if [ "$?" = "0" ] ; then
		                sed -e 's/^\(for i in.*\)\(; do\)$/\1 sftp-server.log\2/' /etc/weekly > /tmp/weekly.tmp && mv /tmp/weekly.tmp /etc/weekly
		        fi
		fi
		test "$logstat" = "1" && sftpinst=$sftpinst`MyGetLocale 'logrot'`"\t"`MyGetLocale 'ok'`"\n" || sftpinst=$sftpinst`MyGetLocale 'logrot'`"\t"`MyGetLocale 'failed'`"\n"
	fi
fi

# End of Installation

# Only for version < 0.6 --> 0.8 & +
$BINDIR/sftp-state fullshutdown > /dev/null
$BINDIR/sftp-state start > /dev/null

sftpinst=$sftpinst"\n"`MyGetLocale 'finishedinst'`"\n\n"`MyGetLocale 'osxreminder'`

clear
echo -e "$sftpinst\n"
